# **рдорд╛рдпрдХреНрд░реЛрд╕реЙрдлреНрдЯ Phi-3.5 tflite рд╡рд╛рдкрд░реВрди Android рдЕреЕрдк рддрдпрд╛рд░ рдХрд░рдгреЗ**

рд╣реЗ рдорд╛рдпрдХреНрд░реЛрд╕реЙрдлреНрдЯ Phi-3.5 tflite рдореЙрдбреЗрд▓реНрд╕ рд╡рд╛рдкрд░рдгрд╛рд░реЗ Android рдЪреЗ рдПрдХ рдирдореБрдирд╛ рдЖрд╣реЗ.

## **ЁЯУЪ рдЬреНрдЮрд╛рди**

Android LLM Inference API рддреБрдореНрд╣рд╛рд▓рд╛ Android рдЕреЕрдкреНрд╕рд╕рд╛рдареА рдореЛрдареНрдпрд╛ рднрд╛рд╖рд┐рдХ рдореЙрдбреЗрд▓реНрд╕ (LLMs) рдкреВрд░реНрдгрдкрдгреЗ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕рд╡рд░ рдЪрд╛рд▓рд╡рдгреНрдпрд╛рдЪреА рдкрд░рд╡рд╛рдирдЧреА рджреЗрддреЗ. рдпрд╛рдЪрд╛ рдЙрдкрдпреЛрдЧ рддреБрдореНрд╣реА рд╡рд┐рд╡рд┐рдз рдХрд╛рдорд╛рдВрд╕рд╛рдареА рдХрд░реВ рд╢рдХрддрд╛, рдЬрд╕реЗ рдХреА рдордЬрдХреВрд░ рддрдпрд╛рд░ рдХрд░рдгреЗ, рдиреИрд╕рд░реНрдЧрд┐рдХ рднрд╛рд╖реЗрдд рдорд╛рд╣рд┐рддреА рдорд┐рд│рд╡рдгреЗ рдЖрдгрд┐ рджрд╕реНрддрдРрд╡рдЬрд╛рдВрдЪреЗ рд╕рд╛рд░рд╛рдВрд╢ рддрдпрд╛рд░ рдХрд░рдгреЗ. рдпрд╛ рдХрд╛рд░реНрдпрд╛рдордзреНрдпреЗ рдЕрдиреЗрдХ рдЯреЗрдХреНрд╕реНрдЯ-рдЯреВ-рдЯреЗрдХреНрд╕реНрдЯ рдореЛрдареНрдпрд╛ рднрд╛рд╖рд┐рдХ рдореЙрдбреЗрд▓реНрд╕рд╕рд╛рдареА рдЕрдВрдЧрднреВрдд рд╕рдорд░реНрдерди рдЖрд╣реЗ, рдЬреНрдпрд╛рдореБрд│реЗ рддреБрдореНрд╣реА рддреБрдордЪреНрдпрд╛ Android рдЕреЕрдкреНрд╕рдордзреНрдпреЗ рдирд╡реАрдирддрдо рдСрди-рдбрд┐рд╡реНрд╣рд╛рдЗрд╕ рдЬрдирд░реЗрдЯрд┐рд╡реНрд╣ AI рдореЙрдбреЗрд▓реНрд╕ рд▓рд╛рдЧреВ рдХрд░реВ рд╢рдХрддрд╛.

Google AI Edge Torch рд╣реА рдПрдХ рдкрд╛рдпрдерди рд▓рд╛рдпрдмреНрд░рд░реА рдЖрд╣реЗ рдЬреА PyTorch рдореЙрдбреЗрд▓реНрд╕рдирд╛ .tflite рд╕реНрд╡рд░реВрдкрд╛рдд рд░реВрдкрд╛рдВрддрд░рд┐рдд рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рд╕рдорд░реНрдерди рджреЗрддреЗ, рдЬреНрдпрд╛рдореБрд│реЗ рддреЗ TensorFlow Lite рдЖрдгрд┐ MediaPipe рд╕рд╣ рдЪрд╛рд▓рд╡рд▓реЗ рдЬрд╛рдК рд╢рдХрддрд╛рдд. рдпрд╛рдореБрд│реЗ Android, iOS рдЖрдгрд┐ IoT рдЕреЕрдкреНрд╕рд╕рд╛рдареА рд╕рдВрдзреА рдирд┐рд░реНрдорд╛рдг рд╣реЛрддреЗ, рдЬреНрдпрд╛рдордзреНрдпреЗ рдореЙрдбреЗрд▓реНрд╕ рдкреВрд░реНрдгрдкрдгреЗ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕рд╡рд░ рдЪрд╛рд▓рд╡рддрд╛ рдпреЗрддрд╛рдд. AI Edge Torch рд╡рд┐рд╕реНрддреГрдд CPU рдХрд╡реНрд╣рд░реЗрдЬ рджреЗрддреЗ, рддрд╕реЗрдЪ рдкреНрд░рд╛рд░рдВрднреА GPU рдЖрдгрд┐ NPU рд╕рдорд░реНрдерди рджреЗрдЦреАрд▓ рдкреНрд░рджрд╛рди рдХрд░рддреЗ. AI Edge Torch, PyTorch рд╕рд╣ рдЬрд╡рд│реВрди рдПрдХрддреНрд░реАрдХрд░рдг рд╕рд╛рдзрдгреНрдпрд╛рдЪрд╛ рдкреНрд░рдпрддреНрди рдХрд░рддреЗ, torch.export() рд╡рд░ рдЖрдзрд╛рд░рд┐рдд рд░рд╛рд╣реВрди Core ATen рдСрдкрд░реЗрдЯрд░реНрд╕рдЪреЗ рдЪрд╛рдВрдЧрд▓реЗ рдХрд╡реНрд╣рд░реЗрдЬ рджреЗрддреЗ.

## **ЁЯкм рдорд╛рд░реНрдЧрджрд░реНрд╢рдХ**

### **ЁЯФе рдорд╛рдпрдХреНрд░реЛрд╕реЙрдлреНрдЯ Phi-3.5 рд▓рд╛ tflite рдордзреНрдпреЗ рд░реВрдкрд╛рдВрддрд░рд┐рдд рдХрд░рд╛**

0. рд╣рд╛ рдирдореБрдирд╛ Android 14+ рд╕рд╛рдареА рдЖрд╣реЗ.

1. Python 3.10.12 рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рд╛.

***рд╕реВрдЪрдирд╛:*** рддреБрдордЪреНрдпрд╛ Python рд╡рд╛рддрд╛рд╡рд░рдгрд╛рд╕рд╛рдареА conda рд╡рд╛рдкрд░рдгреНрдпрд╛рдЪрд╛ рд╡рд┐рдЪрд╛рд░ рдХрд░рд╛.

2. Ubuntu 20.04 / 22.04 (рдХреГрдкрдпрд╛ [google ai-edge-torch](https://github.com/google-ai-edge/ai-edge-torch) рд╡рд░ рд▓рдХреНрд╖ рдХреЗрдВрджреНрд░рд┐рдд рдХрд░рд╛)

***рд╕реВрдЪрдирд╛:*** Azure Linux VM рдХрд┐рдВрд╡рд╛ рддреГрддреАрдп рдкрдХреНрд╖рд╛рдЪреЗ рдХреНрд▓рд╛рдЙрдб VM рд╡рд╛рдкрд░реВрди рддреБрдордЪреЗ рд╡рд╛рддрд╛рд╡рд░рдг рддрдпрд╛рд░ рдХрд░рд╛.

3. рддреБрдордЪреНрдпрд╛ Linux bash рдордзреНрдпреЗ рдЬрд╛, рдЖрдгрд┐ Python рд▓рд╛рдпрдмреНрд░рд░реА рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рд╛.

```bash

git clone https://github.com/google-ai-edge/ai-edge-torch.git

cd ai-edge-torch

pip install -r requirements.txt -U 

pip install tensorflow-cpu -U

pip install -e .

```

4. Hugging Face рд╡рд░реВрди Microsoft-3.5-Instruct рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рд╛.

```bash

git lfs install

git clone  https://huggingface.co/microsoft/Phi-3.5-mini-instruct

```

5. рдорд╛рдпрдХреНрд░реЛрд╕реЙрдлреНрдЯ Phi-3.5 рд▓рд╛ tflite рдордзреНрдпреЗ рд░реВрдкрд╛рдВрддрд░рд┐рдд рдХрд░рд╛.

```bash

python ai-edge-torch/ai_edge_torch/generative/examples/phi/convert_phi3_to_tflite.py --checkpoint_path  Your Microsoft Phi-3.5-mini-instruct path --tflite_path Your Microsoft Phi-3.5-mini-instruct tflite path  --prefill_seq_len 1024 --kv_cache_max_len 1280 --quantize True

```

### **ЁЯФе рдорд╛рдпрдХреНрд░реЛрд╕реЙрдлреНрдЯ Phi-3.5 рд▓рд╛ Android Mediapipe рдмрдВрдбрд▓рдордзреНрдпреЗ рд░реВрдкрд╛рдВрддрд░рд┐рдд рдХрд░рд╛**

рдХреГрдкрдпрд╛ рдкреНрд░рдердо mediapipe рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рд╛.

```bash

pip install mediapipe

```

[рддреБрдордЪреНрдпрд╛ рдиреЛрдЯрдмреБрдХрдордзреНрдпреЗ](../../../../../../code/09.UpdateSamples/Aug/Android/convert/convert_phi.ipynb) рд╣рд╛ рдХреЛрдб рдЪрд╛рд▓рд╡рд╛.

```python

import mediapipe as mp
from mediapipe.tasks.python.genai import bundler

config = bundler.BundleConfig(
    tflite_model='Your Phi-3.5 tflite model path',
    tokenizer_model='Your Phi-3.5 tokenizer model path',
    start_token='start_token',
    stop_tokens=[STOP_TOKENS],
    output_filename='Your Phi-3.5 task model path',
    enable_bytes_to_unicode_mapping=True or Flase,
)
bundler.create_bundle(config)

```

### **ЁЯФе adb push рд╡рд╛рдкрд░реВрди рдореЙрдбреЗрд▓ рддреБрдордЪреНрдпрд╛ Android рдбрд┐рд╡реНрд╣рд╛рдЗрд╕рдЪреНрдпрд╛ рдкрдерд╛рд╡рд░ рдкрд╛рдард╡рд╛**

```bash

adb shell rm -r /data/local/tmp/llm/ # Remove any previously loaded models

adb shell mkdir -p /data/local/tmp/llm/

adb push 'Your Phi-3.5 task model path' /data/local/tmp/llm/phi3.task

```

### **ЁЯФе рддреБрдордЪрд╛ Android рдХреЛрдб рдЪрд╛рд▓рд╡рд╛**

![demo](../../../../../../translated_images/demo.8981711efb5a9cee5dcd835f66b3b31b94b4f3e527300e15a98a0d48863b9fbd.mr.png)

**рдЕрд╕реНрд╡реАрдХреГрддреА**:  
рд╣реЗ рджрд╕реНрддрдРрд╡рдЬ рдорд╢реАрди-рдЖрдзрд╛рд░рд┐рдд AI рднрд╛рд╖рд╛рдВрддрд░ рд╕реЗрд╡рд╛рдВрдЪрд╛ рд╡рд╛рдкрд░ рдХрд░реВрди рднрд╛рд╖рд╛рдВрддрд░рд┐рдд рдХреЗрд▓реЗ рдЧреЗрд▓реЗ рдЖрд╣реЗ. рдЖрдореНрд╣реА рдЕрдЪреВрдХрддреЗрд╕рд╛рдареА рдкреНрд░рдпрддреНрдирд╢реАрд▓ рдЕрд╕рд▓реЛ рддрд░реА, рдХреГрдкрдпрд╛ рд▓рдХреНрд╖рд╛рдд рдШреНрдпрд╛ рдХреА рд╕реНрд╡рдпрдВрдЪрд▓рд┐рдд рднрд╛рд╖рд╛рдВрддрд░реЗ рддреНрд░реБрдЯреА рдХрд┐рдВрд╡рд╛ рдЕрдЪреВрдХрддреЗрдЪреНрдпрд╛ рдЕрднрд╛рд╡рд╛рд╕рд╣ рдЕрд╕реВ рд╢рдХрддрд╛рдд. рдореВрд│ рднрд╛рд╖реЗрддреАрд▓ рдореВрд│ рджрд╕реНрддрдРрд╡рдЬ рдЕрдзрд┐рдХреГрдд рд╕реНрд░реЛрдд рдорд╛рдирд▓рд╛ рдЬрд╛рд╡рд╛. рдорд╣рддреНрддреНрд╡рд╛рдЪреНрдпрд╛ рдорд╛рд╣рд┐рддреАрд╕рд╛рдареА, рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рдорд╛рдирд╡реА рднрд╛рд╖рд╛рдВрддрд░рд╛рдЪреА рд╢рд┐рдлрд╛рд░рд╕ рдХреЗрд▓реА рдЬрд╛рддреЗ. рдпрд╛ рднрд╛рд╖рд╛рдВрддрд░рд╛рдЪрд╛ рд╡рд╛рдкрд░ рдХрд░реВрди рдЭрд╛рд▓реЗрд▓реНрдпрд╛ рдХреЛрдгрддреНрдпрд╛рд╣реА рдЧреИрд░рд╕рдордЬ рдХрд┐рдВрд╡рд╛ рдЪреБрдХреАрдЪреНрдпрд╛ рдЕрд░реНрдерд╛рд╕рд╛рдареА рдЖрдореНрд╣реА рдЬрдмрд╛рдмрджрд╛рд░ рд░рд╛рд╣рдгрд╛рд░ рдирд╛рд╣реА.