### Примерен сценарий

Представете си, че имате изображение (`demo.png`) и искате да генерирате Python код, който обработва това изображение и запазва нова версия на него (`phi-3-vision.jpg`).

Кодът по-горе автоматизира този процес чрез:

1. Настройка на средата и необходимите конфигурации.
2. Създаване на подканващ текст, който инструктира модела да генерира необходимия Python код.
3. Изпращане на подканващия текст към модела и събиране на генерирания код.
4. Извличане и изпълнение на генерирания код.
5. Показване на оригиналното и обработеното изображение.

Този подход използва силата на изкуствения интелект за автоматизация на задачи за обработка на изображения, което ги прави по-лесни и по-бързи за постигане.

[Примерно решение на кода](../../../../../../code/06.E2E/E2E_Nvidia_NIM_Phi3_Vision.ipynb)

Нека разгледаме какво прави целият код стъпка по стъпка:

1. **Инсталиране на необходимия пакет**:
    ```python
    !pip install langchain_nvidia_ai_endpoints -U
    ```
    Тази команда инсталира пакета `langchain_nvidia_ai_endpoints`, като гарантира, че е последната версия.

2. **Импортиране на необходимите модули**:
    ```python
    from langchain_nvidia_ai_endpoints import ChatNVIDIA
    import getpass
    import os
    import base64
    ```
    Тези импорти добавят необходимите модули за взаимодействие с NVIDIA AI endpoints, сигурно управление на пароли, взаимодействие с операционната система и кодиране/декодиране на данни във формат base64.

3. **Настройка на API ключ**:
    ```python
    if not os.getenv("NVIDIA_API_KEY"):
        os.environ["NVIDIA_API_KEY"] = getpass.getpass("Enter your NVIDIA API key: ")
    ```
    Този код проверява дали е зададена променливата на средата `NVIDIA_API_KEY`. Ако не, подканва потребителя да въведе своя API ключ сигурно.

4. **Дефиниране на модел и път до изображението**:
    ```python
    model = 'microsoft/phi-3-vision-128k-instruct'
    chat = ChatNVIDIA(model=model)
    img_path = './imgs/demo.png'
    ```
    Това задава модела, който ще се използва, създава инстанция на `ChatNVIDIA` със зададения модел и дефинира пътя до файла с изображението.

5. **Създаване на текстова подканва**:
    ```python
    text = "Please create Python code for image, and use plt to save the new picture under imgs/ and name it phi-3-vision.jpg."
    ```
    Това дефинира текстова подканва, която инструктира модела да генерира Python код за обработка на изображение.

6. **Кодиране на изображението в base64**:
    ```python
    with open(img_path, "rb") as f:
        image_b64 = base64.b64encode(f.read()).decode()
    image = f'<img src="data:image/png;base64,{image_b64}" />'
    ```
    Този код чете файла с изображението, кодира го в base64 и създава HTML таг за изображение с кодираните данни.

7. **Комбиниране на текст и изображение в подканва**:
    ```python
    prompt = f"{text} {image}"
    ```
    Това комбинира текстовата подканва и HTML тага за изображение в единен низ.

8. **Генериране на код с ChatNVIDIA**:
    ```python
    code = ""
    for chunk in chat.stream(prompt):
        print(chunk.content, end="")
        code += chunk.content
    ```
    Този код изпраща подканвата към `ChatNVIDIA` model and collects the generated code in chunks, printing and appending each chunk to the `code` низ.

9. **Извличане на Python код от генерираното съдържание**:
    ```python
    begin = code.index('```python') + 9
    code = code[begin:]
    end = code.index('```')
    code = code[:end]
    ```
    Това извлича реалния Python код от генерираното съдържание, като премахва markdown форматирането.

10. **Изпълнение на генерирания код**:
    ```python
    import subprocess
    result = subprocess.run(["python", "-c", code], capture_output=True)
    ```
    Това изпълнява извлечения Python код като подпроцес и улавя неговия изход.

11. **Показване на изображенията**:
    ```python
    from IPython.display import Image, display
    display(Image(filename='./imgs/phi-3-vision.jpg'))
    display(Image(filename='./imgs/demo.png'))
    ```
    Тези редове показват изображенията с помощта на модула `IPython.display`.

**Отказ от отговорност**:  
Този документ е преведен с помощта на машинни AI услуги за превод. Въпреки че се стремим към точност, имайте предвид, че автоматизираните преводи може да съдържат грешки или неточности. Оригиналният документ на неговия изходен език трябва да се счита за авторитетен източник. За критична информация се препоръчва професионален превод от човек. Не носим отговорност за никакви недоразумения или погрешни интерпретации, произтичащи от използването на този превод.